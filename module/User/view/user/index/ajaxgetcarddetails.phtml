<script>
    $('#hide').click(function() {
        $.fancybox.close();
    });
</script>

<?php
if (isset($this->cardDetailes) && !empty($this->cardDetailes) && count($this->cardDetailes) != 0) { ?>
<div class="packages">
<?php 
    $cardDetails = $this->cardDetailes;
    //echo "<pre>"; print_r($cardDetails);
        ?>
        <input type='hidden' name='pkgId' id="pkgId" value="<?php echo $cardDetails->package_id; ?>" />
        <input type='hidden' name='code_assign_id' id="code_assign_id" value="<?php echo $cardDetails->code_assign_id; ?>" />
        <input type='hidden' name='transaction_id' id="transaction_id" value="<?php echo $cardDetails->transaction_id; ?>" />
        <input type='hidden' name='user_pkg_id' id="user_pkg_id" value="<?php echo $cardDetails->user_package_id; ?>" />
        <button class="close" type="button" onclick="closeorderdetail('<?php echo $cardDetails->user_package_id; ?>');"><span aria-hidden="true">Ã—</span></button>	
            <div class="row">
            <div class="col-sm-6">
            	<ul class="package-info" style="width:100%;">
                <li><strong>Card Number: </strong><span><?php echo $cardDetails->assign_card_no; ?></span></li>	
                <li><strong>Activation Code: </strong><span><?php echo $cardDetails->assign_activation_code; ?></span></li>	
                <li><strong>Valid till: </strong>
                      <span id="valid_till_<?php echo $cardDetails->user_package_id; ?>">
                        <?php echo date('d-m-Y H:i:s', strtotime($cardDetails->valid_till)) ?>
                    </span>
                </li>	
                <li>
                    <strong>Board: </strong>
                    <span>
                        <?php echo $cardDetails->board_name; ?>
                    </span>
                </li>
                
                <li>
                    <strong>Class: </strong>
                    <span>
                        <?php echo $cardDetails->class_name; ?>
                    </span>
                </li>
                
                <li>
                    <strong>Payment Mode: </strong>
                    <span>
                        <?php echo ($cardDetails->pkg_payment_type == 'cod') ? 'COD' : 'Online' ; ?>
                    </span>
                </li>
                <?php if($cardDetails->transaction_product_type == 'study') { ?>
                <li>
                    <strong>Extension Code: </strong>
                    <span id="extension_div_<?php echo $cardDetails->user_package_id; ?>">
                        <?php 
                            if($cardDetails->extension_used_status == 1) {
                                echo $cardDetails->assign_extension_code;
                            } else if(($cardDetails->pkg_payment_type == 'cod')) { ?>
                                <input style="display: inline-block; width: 43%;" type="text" data-cai="<?php echo $cardDetails->code_assign_id; ?>" data-tranid="<?php echo $cardDetails->transaction_id; ?>" data-usrpkgid="<?php echo $cardDetails->user_package_id; ?>" class="form-control" name="extension_code_<?php echo $cardDetails->user_package_id; ?>" id="extension_code_<?php echo $cardDetails->user_package_id; ?>" value="" placeholder="Please enter extension code" />
                                <input style="display: inline-block;"  type="button" class="btn btn-primary check_extension_code" id="check_ext_code_<?php echo $cardDetails->user_package_id; ?>" value="APPLY" ><br/>
                                <span class="errorfrm" id="erroextensioncode_<?php echo $cardDetails->user_package_id; ?>" style="float:none; display: block; color: red; clear: both; text-align: left;  margin-left: 34%;"></span>
                                <span class="errorfrm" id="successextensioncode_<?php echo $cardDetails->user_package_id; ?>" style="float:none; display: block; color: green; clear: both; text-align: left;  margin-left: 34%;"></span>
                            <?php } else { echo "N/A"; } ?>
                    </span>
                </li>
                <?php } else { ?>
                <li>
                    <strong>Order Status: </strong>
                    <span>
                        <?php echo ($cardDetails->approval_status == '0') ? 'Processing' : $cardDetails->status_name . " - " . $cardDetails->comment; ?>
                    </span>
                </li>    
                <?php } ?>
                <?php                         
                $invoice_id = '';
                if($cardDetails->study_invoice_id != '') {
                    $invoice_id = $cardDetails->study_invoice_id;
                } else if($cardDetails->tab_invoice_id != "") {
                    $invoice_id = $cardDetails->tab_invoice_id;
                } else if($cardDetails->sdcard_invoice_id != "") {
                    $invoice_id = $cardDetails->sdcard_invoice_id;
                } else {
                    $invoice_id = $cardDetails->invoice_id;                               
                }
                if($invoice_id != "") { ?>
                <li>
                    <strong>Invoice Number: </strong>
                    <span>
                        <?php echo $invoice_id; ?>
                    </span>
                </li>
                <?php } ?>
            </ul>
            </div>
  
            </div>
<?php
} else {
    echo 'No card details exists';
}
?>
<script>
    $(document).ready(function(){
       
       $('.check_extension_code').click(function(){
           
            var cai = $(this).prev().attr('data-cai');
            var excode = $.trim($(this).prev().val());
            var tranid = $(this).prev().attr('data-tranid');
            var upkgid = $(this).prev().attr('data-usrpkgid');
            var submit = true;
            
            if($.trim(excode) == "") {
                $('#erroextensioncode_' + upkgid).html('Please enter extension code!');
                submit = false;
                return false;
            } else {
                $('#erroextensioncode_' + upkgid).html('');
            }
            
            if(submit) {
                $.ajax({
                    type: 'POST',
                    url: '<?php echo $this->Url("validateextensioncode") ?>',
                    data: {cai: cai, excode:excode, tranid:tranid, upkgid:upkgid},
                    success: function(response) {
                        if(response == '0') {
                            $('#erroextensioncode_' + upkgid).html('Invalid extension code!!');
                        }
                        
                        if(response == '2') {
                            $('#erroextensioncode_' + upkgid).html('This extension code has been alreday used!');
                        }
                        
                        if(response != '0' && response != '2') {
                            var response = JSON.parse(response);
                            if(response != '0' && response.valid_date!= undefined && response.valid_date != '') {
                                $('#successextensioncode_' + upkgid).html('Congratulations!! Your smart extension code is accepted.');
                                $('#check_ext_code_' + upkgid).remove();
                                $('#extension_code_' + upkgid).remove();
                                $('#extension_div_' + upkgid).prepend(excode);
                                $('#valid_till_' + upkgid).html(response.valid_date);
                                $('.mysubscription').find('table tr td.update_valid_till_' + upkgid).html(response.formated_valid_date);
                            }
                        }
                    }
                });
            } else {
                return false;
            }
        
       });
     
    });
</script>