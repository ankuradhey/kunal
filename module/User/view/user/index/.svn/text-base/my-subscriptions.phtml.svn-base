<link href="<?php echo $this->cdn("/css/website/profile.css"); ?>" rel="stylesheet">
<script type="text/javascript" src="<?php echo $this->basePath()?>/js/website/externals/package.js"></script>
<div id="content" class="profile-pages">
    <div class="container">
        <div class="row">
            <div class="myprofile-content">
                <div class="profile-view globle-click clearfix">
                    <strong>My Subscriptions</strong>
                    <i class="icons-ar"></i>	
                </div>
                <?php echo $this->partial('zfc-user/user/profile-menu.phtml', array('page' => 'mySubscriptions', 'addedmentors' => count($this->addedMentors), 'addedStudents' => count($this->addedStudents))); ?>
                <section class="profile-block">
                    <?php // echo count($this->packages);
                    if (isset($this->packages) && count($this->packages) != 0) { ?>	
                        <div class="addChild_Container">
                            <h3>Package Detail</h3>
                            <div class="mentor-inner mysubscription">

                                <div class="table-responsive">
                                    <table class="table table-bordered">

                                        <tr>
                                            <th class="cols-1">Package(s)</th>
                                            <th>Purchased For</th>
                                            <th>Package Type</th>
                                            <th>Payment Mode</th>
                                            <th>Card Details</th>
                                            <th>Valid from</th>
                                            <th>Renewal Due</th>
                                       <!-- <th>Price</th>
                                            <th>Discount</th>
                                            <th>Net Total</th> -->
                                            <th>Invoice</th>
                                            <th>Status</th>
                                        </tr>
                                        <?php
                                        if (count($this->packages) != 0) {
                                            foreach ($this->packages as $key => $packages) { //echo "<pre>"; print_r($packages);

                                                if ($packages->currency_type == "USD") {
                                                    $currency = "$ ";
                                                } else if ($packages->currency_type == "SGD") {
                                                    $currency = "S$ ";
                                                } else {
                                                    $currency = "Rs. ";
                                                }

                                                $validFrom1 = explode(' ', $packages->valid_from);
                                                $validFrom = explode(' ', date('F j Y', strtotime($validFrom1[0])));

                                                $validTill1 = explode(' ', $packages->valid_till);
                                                $validTill = explode(' ', date('F j Y', strtotime($validTill1[0])));
                                                $pDate = date('Y-m-d H:i:s');
                                                if($packages->status == 2 && $packages->transaction_product_type=='tablet'){
                                                $status = "Active";
                                                }else if($packages->status == 3 && $packages->transaction_product_type=='sdcard'){
                                                $status = "Active";    
                                                }else if (strtotime($pDate) > strtotime($packages->valid_till) || $packages->status == 3) {
                                                    $status = "Expired";
                                                } elseif ($packages->status == '1') {
                                                    $status = "Active";
                                                } elseif ($packages->status == '2') {
                                                    $status = "Deactive";
                                                } else {
                                                    $status = "Inactive";
                                                }

                                                if ($packages->package_category == '1') {
                                                    $validclass = $packages->class . ' - ' . $nextclassnameArray[$packages->actual_package_id];
                                                } else {
                                                    $validclass = $packages->class;
                                                }
                                                 // echo '<pre>';print_r($packages);//echo '</pre>';die('Macro Die');
                                                ?>
                                      
                                                <tr class="t1-content-row">
                                                    <td class="sub-first-td sub-pack-1" id="data-row-<?php echo $key ?>-1">
                                                        <a class="link-my-sub" href="javascript:void(0);" onclick="getPackage(<?php echo $packages->user_package_id; ?>, '<?php echo $packages->actual_package_id; ?>', '<?php echo $packages->package_category; ?>')">
                                                            <?php echo $packages->board . ', (' . $validclass . '), ' . $packages->package_name ?>
                                                        </a>
                                                        </div>
                                                    </td>
                                                    <td class="sub-first-td sub-pack-1" id="data-row-<?php echo $key ?>-5">
                                                        <?php if ($packages->user_id != $packages->purchaser_id) { ?>
                                                            <?php if ($packages->user_id == $this->zfcUserIdentity()->getId()) { ?>
                                                                Self
                                                            <?php } else { ?>
                                                                <?php echo $packages->display_name ?>
                                                                <?php
                                                            }
                                                        } else {
                                                            ?>
                                                            self
                                                        <?php } ?>
                                                    </td>
                                                    <td>
                                                        <?php echo $packages->package_type; ?></td>
                                                    <td><?php 
                                                    if($packages->pkg_payment_type == 'cod') {
                                                        echo 'COD';
                                                    } else if($packages->pkg_payment_type == 'offline') {
                                                        echo 'Offline';
                                                    } else {
                                                        echo 'Online';
                                                    }
                                                    
                                                    ?></td>
                                                    <td><?php if($packages->code_assign_id) { ?> <a href="javascript:void(0);" class="view_card_details" onclick="getCardDetails(<?php echo $packages->user_package_id; ?>, '<?php echo $packages->code_assign_id; ?>', '<?php echo $packages->package_category; ?>', '<?php echo $packages->transaction_id; ?>', '<?php echo $packages->user_package_id; ?>')">View</a><?php } else echo 'NA'; ?></td>
                                                    <td class="sub-pack-2" id="data-row-<?php echo $key ?>-2"><?php echo $validFrom[1] . ' ' . $validFrom[0] . ', ' . $validFrom[2]; ?></td>
                                                    <td class="sub-pack-3 update_valid_till_<?php echo $packages->user_package_id;?>" id="data-row-<?php echo $key ?>-3"><?php echo $validTill[1] . ' ' . $validTill[0] . ', ' . $validTill[2]; ?></td>
<!--                                                    <td class="center-txt sub-det-5" id="ord-row-<?php echo $key ?>-5"><?php
//                                                        echo $currency;
//                                                        echo $packages->package_price;
                                                        ?>
                                                    </td>-->
<!--                                                    <td class="center-txt sub-det-4" id="ord-row-<?php echo $key ?>-4"><?php
//                                                        echo $curr ency;
//                                                        if ($packages->discount_amount == '') {
//                                                            $packages->discount_amount = 0;
//                                                            echo "0";
//                                                        } else {
//                                                            echo $packages->discount_amount;
//                                                        }
                                                        ?>
                                                    </td>-->
<!--                                                    <td class="center-txt sub-det-6" id="ord-row-<?php //echo $key ?>-6"><?php
//                                                        echo $currency;
//                                                        if ($packages->paid_amount == '' || $packages->paid_amount == 0) {
//                                                            echo " 0";
//                                                        } else {
//                                                            echo round(floatval($packages->package_price) - floatval($packages->discount_amount), 2);
//                                                        }
                                                        ?></td>-->
                                                <td class="center-text">
                                                    <?php $filename = getcwd() . "/public/uploads/invoice/" . $packages->order_id . ".pdf";
                                                    if($packages->package_type=='tablet'){
                                                        echo 'Invoice would be sent along with Tablet';
                                                    }elseif (file_exists($filename) ) { ?>
                                                        <a href="<?php echo $this->serverUrl($this->url('invoice')); ?>/<?php echo $packages->order_id; ?>">Invoice</a>
                                                    <?php } else {
                                                        echo 'NA';
                                                    }?>
                                                </td>
                                                <td class="sub-pack-4" id="data-row-<?php echo $key ?>-4"><?php if ($status == "Active") { ?><span class="status-green"><?php echo $status; ?></span><?php } else { ?><span class="status-red"><?php echo $status; ?></span><?php } ?></td>
                                                </tr>
                                                <tr class="package-details" id="orderDetailes<?php echo $packages->user_package_id; ?>">
                                                    <td colspan="9">

                                                    </td>
                                                </tr>                                                            
                                                <?php
                                            }
                                        }
                                        ?>
                                        
                                        <?php
                                        ?>
                                    </table>
                                </div>

                            </div>
                        </div>          
                        <?php } else { ?>
                        
                            <div class="right-content">
                                <div class="right-div" style="min-height: 870px;">
                                    <div class="user-sub-table user-table-top borderRadius">
                                        <div style="text-align:center; padding:50px; font-size: 15px; background: #f3f3f3; border-radius:6px">No records found</div>
                                    </div>
                                </div>
                            </div>
                      
                    <?php } ?>

                    <?php if (count($this->satpackages) != 0) {
                        ?>
                        <div class="addChild_Container">
                            <h3>SAT Package Detail</h3>
                            <div class="mentor-inner mysubscription">
                                <div class="table-responsive">
                                    <table class="table table-bordered">
                                        <tr>
                                            <th class="cols-1">Order Id</th>
                                            <th>Name of the Package</th>
                                            <th>Date of Purchase</th>
                                            <th>Status</th>
                                            <th>Price</th>
                                        </tr>
    <?php
    if (count($this->satpackages) != 0) {
        foreach ($this->satpackages as $package) {
            ?>
                                                <tr class="t1-content-row">

                                                    <td><?php echo $this->userorderdetail[$package->user_package_id]; ?></td>  
                                                    <td><?php echo $package->package_name; ?></td>
                                                    <td><?php echo date("F j Y", strtotime($package->user_package_date_added)); ?></td>
                                                    <td><?php echo $package->user_package_status; ?></td>
                                                    <td><?php echo $package->package_value; ?></td>
                                                </tr>
            <?php
        }
    }
    ?>
                                    </table>
                                </div>
                            </div>
                        </div>
    <?php
}
?>
                </section>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
    var a = $("#nav_find").val();
    $("#" + a).addClass("container-nav-current");
    $(document).ready(function() {
        $("#profile").height($(".right-content").height());
    });
    $(window).resize(function() {
        $("#profile").height($(".right-content").height());
    });
    function getPackage(packageId, actual_package_id, package_category) {
        $.ajax({
            type: 'POST',
            url: '<?php echo $this->Url('ajaxsubscriptions'); ?>',
            data: {packageId: packageId, actual_package_id: actual_package_id, package_category: package_category},
            beforeSend: function() {
                $('#orderDetailes' + packageId).show();
                $('#orderDetailes' + packageId).html('<td colspan="9" class="ajaxloader"> <img src="<?php echo $this->cdn() ?>/images/website/loading.gif" /></td>');
            },
            success: function(data) {
                if (data != 'nodataFound') {
                    $(".package-details").hide();
                    $('#orderDetailes' + packageId).show();
                    $('#orderDetailes' + packageId).html('<td colspan="9">' + data + '</td>');
                } else {
                    $('#orderDetailes' + packageId).html('');
                }
            }
        });
    }
    function closeorderdetail(id) {
        $("#orderDetailes" + id).hide();
    }
    
    function getCardDetails(packageId, code_assign_id, package_category, transaction_id, user_pkg_id) {
        $.ajax({
            type: 'POST',
            url: '<?php echo $this->Url('ajaxgetcarddetails'); ?>',
            data: {packageId: packageId, code_assign_id: code_assign_id, package_category: package_category, transaction_id:transaction_id, user_pkg_id:user_pkg_id},
            beforeSend: function() {
                $('#orderDetailes' + packageId).show();
                $('#orderDetailes' + packageId).html('<td colspan="9" class="ajaxloader"> <img src="<?php echo $this->cdn() ?>/images/website/loading.gif" /></td>');
            },
            success: function(data) {
                if (data != 'nodataFound') {
                    $(".package-details").hide();
                    $('#orderDetailes' + packageId).show();
                    $('#orderDetailes' + packageId).html('<td colspan="9">' + data + '</td>');
                } else {
                    $('#orderDetailes' + packageId).html('');
                }
            }
        });
    }
</script>
<style>
    .status-green{
        color: #2D5B00;
        font-size: 14px;
    }
    .status-red{
        color: #8B0000;
        font-size: 14px;
    }
</style>